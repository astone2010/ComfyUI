version: '3.8'

services:
  comfyui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: comfyui
    restart: unless-stopped
    
    # GPU support (NVIDIA)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    ports:
      - "8188:8188"
    
    volumes:
      # Model directories
      - ./models/checkpoints:/comfyui/models/checkpoints
      - ./models/vae:/comfyui/models/vae
      - ./models/loras:/comfyui/models/loras
      - ./models/embeddings:/comfyui/models/embeddings
      - ./models:/comfyui/models
      
      # Input/Output directories
      - ./input:/comfyui/input
      - ./output:/comfyui/output
      
      # Custom nodes
      - ./custom_nodes:/comfyui/custom_nodes
    
    environment:
      - CUDA_VISIBLE_DEVICES=0
      # Uncomment to enable manager
      # - COMFYUI_ENABLE_MANAGER=1
    
    # Resource limits (adjust as needed)
    mem_limit: 16g
    
    networks:
      - comfyui-network

  # Optional: Add a reverse proxy for better access control
  # nginx:
  #   image: nginx:latest
  #   container_name: comfyui-nginx
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #   depends_on:
  #     - comfyui
  #   networks:
  #     - comfyui-network

networks:
  comfyui-network:
    driver: bridge
